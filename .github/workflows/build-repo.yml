---
name: Build Pacman Repo
permissions:
  contents: write

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  build-pacman-repo:
    runs-on: ubuntu-latest
    container:
      image: archlinux/archlinux:base-devel
    env:
      CONTAINER_DIR: pkgbuilds
    strategy:
      fail-fast: true
    steps:
      - name: Container Setup
        run: |
          pacman -Syy --disable-download-timeout --needed --noconfirm \
            archlinux-keyring
          pacman -Syu --disable-download-timeout --needed --noconfirm \
            base-devel \
            cmake \
            git \
            pixman \
            libdrm \
            cairo \
            pango \
            wget
          pacman -Scc --noconfirm

      - name: Download Pacman Repo Builder
        run: |
          wget \
            "https://github.com/LizardByte/pacman-repo-builder/releases/latest/download/build-pacman-repo" \
            -O /usr/bin/build-pacman-repo
          chmod +x /usr/bin/build-pacman-repo

          # patch makepkg to allow running as root
          build-pacman-repo patch-makepkg --replace

      - name: Checkout
        uses: actions/checkout@v5

      - name: Configure Git directory
        run: git config --global --add safe.directory /__w/hyprspiral/hyprspiral

      - name: Init
        run: |
          # create the destination directory for built packages
          mkdir -p repo

          # patch the build flags
          # shellcheck disable=SC2016  # we don't want to expand the expression here
          sed -i 's,#MAKEFLAGS="-j2",MAKEFLAGS="-j$(nproc)",g' /etc/makepkg.conf

      - name: Build Pacman Repo
        run: |
          # generate build-pacman-repo.yaml
          build-pacman-repo print-config \
            --repository repo/hyprspiral.db.tar.gz \
            --container "${CONTAINER_DIR}" \
            --require-pkgbuild \
            --require-srcinfo \
            --with-record-failed-builds repo/failed-build-records.yaml \
            --with-install-missing-dependencies true \
            --with-clean-before-build false \
            --with-clean-after-build false \
            --with-force-rebuild true \
            --with-pacman pacman \
            --with-arch-filter x86_64 \
            --with-check inherit \
            --with-packager "hyprspiral builder <builder@hyprspiral.local>" \
            --with-allow-failure false \
            --with-dereference-database-symlinks true \
            > build-pacman-repo.yaml

          # validate .SRCINFO files
          build-pacman-repo sync-srcinfo || \
            echo "::warning:: .SRCINFO files mismatch" >> "${GITHUB_STEP_SUMMARY}" && \
            build-pacman-repo sync-srcinfo -u

          # Stage 1: Build Hyprland first (required dependency for plugins)
          echo "::group::Building Hyprland base package"
          build-pacman-repo build --package hyprland-spiral
          echo "::endgroup::"

          # Stage 2: Build all plugins and other packages
          echo "::group::Building plugins and dependencies"
          build-pacman-repo build --exclude hyprland-spiral
          echo "::endgroup::"

          # ensure files are present in the repo
          repo_files=$(ls repo)
          if [[ -z "${repo_files}" ]]; then
            echo "::error:: No files found in repo"
            exit 1
          fi

      - name: Prepare Release Info
        id: release_info
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]] || [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            # Daily/nightly build
            echo "tag=nightly" >> $GITHUB_OUTPUT
            echo "name=Nightly Build $(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "make_latest=false" >> $GITHUB_OUTPUT
          else
            # Tagged release
            echo "tag=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "name=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "make_latest=true" >> $GITHUB_OUTPUT
          fi

      - name: Create/Update GitHub Release
        uses: ncipollo/release-action@v1.20.0
        with:
          allowUpdates: true
          artifactErrorsFailBuild: true
          artifacts: repo/*
          generateReleaseNotes: true
          makeLatest: ${{ steps.release_info.outputs.make_latest }}
          name: ${{ steps.release_info.outputs.name }}
          prerelease: ${{ steps.release_info.outputs.prerelease }}
          tag: ${{ steps.release_info.outputs.tag }}
          token: ${{ secrets.GITHUB_TOKEN }}
